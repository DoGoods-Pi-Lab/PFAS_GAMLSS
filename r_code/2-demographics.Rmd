---
title: "Demographics: PFAS and MMIP DNAm data (BS only!)"
author: "Rebekah Petroff"
date: "9/13/2021"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_knit$set(root.dir = normalizePath("L:/MMIP EPIC/PFAS/PFAS_bs")) #set your wd
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, comment = NA) #dont include the code in your output, no warnings, no hashes before output
options(digits = 3)
library(tidyverse) #for dplyr and other tidyverse commands
library(psych) #tables
library(gt) #pretty printing of tables
library(corrplot) #corr plot
```


This document is the key to building all of our tables for the manuscript describing the exposure and demographics of the subset of MMIP used for PFAS and EPIC analysis. 

```{r setup our files}
load("./preprocess_output/finalpheno.rda")
pheno <- orderedfinalgroup #read in the pheno

```


## Exposures 


For exposures, the first question to consider is if we should drop any of those exposures. Our analysis plan is to keep any variables as is with at least 60% of samples above the LOD. Additionally, any samples that are less than 60% detected above the LOD but more than 20% detected will be dichotomized (detected yes/no). Given these criteria, the following will happen to the variables: 


```{r exposure summary}
#now for the summary stats!
lodCounts <- colSums(pheno[,59:67]) #count LODS
lodCounts <- as.data.frame(lodCounts) #make it into a data frame
lodCounts[2] <- lodCounts[1]/nrow(pheno)
colnames(lodCounts) <- c("Number Above LOD", "Percent Above LOD")
lodCounts$`Percent Below LOD` <- 1-lodCounts$`Percent Above LOD`
rownames(lodCounts) <- gsub("_cat","",rownames(lodCounts))

lodCounts$`Analysis Plan` <- ifelse(lodCounts$`Percent Above LOD`>0.595, "Keep as Numeric", #marked for rounding up
                                    ifelse (lodCounts$`Percent Above LOD`<.6 & lodCounts$`Percent Above LOD` > 0.2, "Dichotomize", 
                                    "Remove from Analysis"))
gt(lodCounts, 
   rownames_to_stub = TRUE)
```

$$\\[0.5in]$$


All of this is based on a total MMIP sample size with PFAS measurements and passing EPIC data of: 

```{r samp size}
nrow(pheno)
```

$$\\[0.5in]$$



For the exposure variables we are keeping, the variables can be described as follows (reported in untransformed values, with LOD replaced by LOD/sqrt(2)): 


```{r exposure assessment for all kept variables}
#first get the data we need from the original file
expKeep <- lodCounts %>%
               filter(`Analysis Plan` != "Remove from Analysis")

expKeepList <- rownames(expKeep)               

expsNum <- pheno%>% select(ends_with("LOD")) 
drop <- c("PFOSA_LOD", "PFHpA_LOD") #drop those we are droppping
expsNum <- expsNum[,!(names(expsNum) %in% drop)]
names(expsNum) <- gsub("_LOD","", names(expsNum))

#pivot longer for easy stats 
longExpNum <- pivot_longer(expsNum, 
                           cols = everything(),
                           names_to = "Exposure", 
                           values_to = "Concentration")
summaryExp<-longExpNum%>%
  group_by(Exposure) %>%
  summarise( #create table with LOD counts
  n=n(),
  GM=exp(mean(log(Concentration), na.rm = TRUE)),
  GSD=exp(sd(log(Concentration), na.rm = TRUE)),
  Mean= mean(Concentration, na.rm = TRUE), 
  Min = min(Concentration, na.rm = TRUE),
  Max= max(Concentration, na.rm = TRUE)
)

write.csv(summaryExp, "./preprocess_output/ExposureSummary.csv", row.names = FALSE)
gt(summaryExp, 
   rownames_to_stub = TRUE)
```

$$\\[0.5in]$$

**Visually, we can see that the distributions look like this:**


```{r epxousre visualization, fig.height=6, fig.width=6}
bp <- ggplot(longExpNum, aes(x=Exposure, y=Concentration, group=Exposure)) + 
  geom_boxplot(aes(fill=Exposure))+
  geom_jitter(col="black", size=0.4, alpha=0.9)+
  ggtitle("Untransformed Concetrations of PFAS data in MMIP")+
  theme(legend.position = "none")
bp


## PFHxS, PFOA, PFOS, PFNA, PFDA, PFUnDA, MeFOSAA

```






```{r epxousre visualization log, fig.height=6, fig.width=6}
bp <- ggplot(longExpNum, aes(x=Exposure, y=Concentration, group=Exposure)) + 
  geom_boxplot(aes(fill=Exposure))+
  geom_jitter(col="black", size=0.4, alpha=0.9)+
  ggtitle("Log-2 Transformed Concetrations of PFAS data in MMIP")+
  scale_y_continuous(trans='log2')+
  ylab("Log2(Concenctration")+
  theme(legend.position = "none")
bp

```
$$\\[0.5in]$$

**How are these exposures related to each other?**


```{r correlation, fig.height=6, fig.width=6}
expCor <- cor(expsNum)

corrplot(expCor, method = 'number', order = 'AOE', type = 'upper')
```
$$\\[0.5in]$$

There are some correlations, but most are not that strong (as indicated by how faint or saturated the color of the R2 number is). 

$$\\[0.8in]$$

## Demographics



### Numeric Variables



First, for the numeric variables, we can look at the distributions a bit differently.

```{r demographics, fig.height=6, fig.width=8}
#MMIP population demographics
demographics <- pheno[c(15:36, 80, 89:98)] #select all your vas of interest

summaryDem<-describe(demographics) #you can save this for more details

#numeric varia
numVars <-demographics%>% select( Gravida, Parity, mtr_age_yrs,  apgar_first, apgar_five, prepreg_wt_kg, postpreg_wt_kg, mtr_ht_cm, prepreg_BMI, gest_age_del, no_days2deliv, gest_age_del, brthwt_gms, birthlength, headcirc) #here only use the numeric ones at first

numVars <- as.data.frame(apply(numVars, 2, as.numeric))
summary(numVars) 


longNumVars <- pivot_longer(numVars, 
                            cols= everything())

np <- ggplot(longNumVars, aes(x = value, fill=as.factor(name))) +
      geom_histogram()+
      facet_wrap(~name, scales = "free")+
      ggtitle("Histogram of Numeric Variables")+
      xlab("Values from Measurement")+
      ylab("Count")+
      theme_minimal()+
      theme(legend.position = "none")

np



```
$$\\[0.5in]$$
```{r correlation, fig.height=6, fig.width=6}
expNumLog <- pheno%>% select(starts_with("ln")) 
drop <- c("ln_PFOSA", "ln_PFHpA") #drop those we are droppping
expNumLog <- expNumLog[,!(names(expNumLog) %in% drop)]
names(expNumLog) <- gsub("ln_","", names(expNumLog))

PCs <- pheno %>% select(starts_with("PC"))

expNumVars <- cbind(expNumLog, numVars, PCs)
completeVars <- expNumVars[complete.cases(expNumVars), ]
newCor <- cor(completeVars)

corrplot(newCor, method = 'ellipse', order = 'AOE', type = 'upper')
```



### Categorical Variables



For these, we are interested in how many in each category, as well as the number of NAs. The following are the summary for these. 



```{r cat vars}
demographics%>%dplyr::count(marital_status)
demographics%>%dplyr::count(smoking_stat)
demographics%>%dplyr::count(smoking_cat)
demographics%>%dplyr::count(ethnicity_synthesized)
demographics%>%dplyr::count(nonwhite)
demographics%>%dplyr::count(race_3cat)
demographics%>%dplyr::count (edu)
demographics%>%dplyr::count(income_num)
demographics%>%dplyr::count(occupation)
demographics%>%dplyr::count(rod)
demographics%>%dplyr::count(preterm)
demographics%>%dplyr::count(pregcomp)
demographics%>%dplyr::count(sex_word)

expCat <- as.data.frame(cbind (demographics$smoking_cat, demographics$nonwhite, demographics$race_3cat, demographics$income_num, demographics$sex, demographics$marital_status))
expCat <- as.data.frame(apply(expCat, 2, as.factor))
names(expCat) <- c("SmokeCat", "Nonwhite", "Race3Cat","Income", "sex", "Marital")


for (i in 1:length(expNumLog)) {
  for (x in 1:length (expCat)){
  expTest <- as.data.frame(cbind(expNumLog[i], expCat[x]))
  expAnova <- lm(expTest[,1]~expTest[,2])
  print(summary(expAnova))
  }
  }

```
